name: validate & release to artifacthub
on:
  push:
    branches: [ main ]
    paths:
      - 'charts/**'
      - 'common_library/charts/library/common/**'
env:
  DATREE_TOKEN: ${{ secrets.DATREE_TOKEN }} 
jobs:
  test:
    name: validate helm
    strategy:
      matrix:
        version: ["1.23.14","1.24.8", "1.25.4"]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'true'

      - name: copy common library into the right spot
        run: cp -R common_library/charts/library/common/ charts/common/

      - name: Run Datree Policy Check
        uses: datreeio/action-datree@main
        with:
          path: 'charts'
          isHelmChart: true
          cliArguments: '--schema-version ${{ matrix.version }}'
          

  release:
    name: release helm charts
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: checkout git code
        uses: actions/checkout@v3
        with:
          submodules: 'true'

      - name: copy common library into the right spot
        run: cp -R common_library/charts/library/common/ charts/common/

      - name: Publish Helm charts
        uses: stefanprodan/helm-gh-pages@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: loeken
          repository: helm-charts